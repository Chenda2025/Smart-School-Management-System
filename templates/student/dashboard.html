<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard ‚Ä¢ Elite International School</title>
    
    {% load static %}
    {% load filters %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/student_dashboard.css' %}">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100vh;
        }
        .main-content { margin-left: 280px; padding: 2rem; }
        @media (max-width: 992px) { .main-content { margin-left: 0; padding: 1rem; } }
        .page-header {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border-radius: 32px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(99,102,241,0.4);
            margin-bottom: 3rem;
        }
        .page-header h1 { font-size: 3.5rem; font-weight: 700; }
        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
            transition: all 0.4s;
        }
        .stat-card:hover { transform: translateY(-10px); box-shadow: 0 30px 60px rgba(99,102,241,0.5); }
        .stat-icon { font-size: 3rem; margin-bottom: 1rem; }
        .stat-number { font-size: 3rem; font-weight: 700; }
        .grade-A { color: #10b981; }
        .grade-B { color: #3b82f6; }
        .grade-C { color: #f59e0b; }
        .grade-D { color: #f97316; }
        .grade-F { color: #ef4444; }
        .progress { height: 20px; border-radius: 10px; }
        .timetable { background: rgba(255,255,255,0.1); border-radius: 24px; padding: 2rem; }
        .timetable th { background: rgba(255,255,255,0.1); }
        .today-class { background: rgba(59,130,246,0.3); font-weight: bold; }
        .quote { font-style: italic; font-size: 1.3rem; opacity: 0.9; }
        .rank-badge { font-size: 2rem; padding: 1rem 2rem; border-radius: 20px; }
    </style>
</head>
<body>
    {% include 'includes/sidebar_student.html' %}

    <div class="main-content">
        <div class="container-fluid py-5">
            <!-- WELCOME HEADER -->
            <div class="page-header">
                <h1>WELCOME BACK, {{ student.user.get_full_name|upper }}</h1>
                <p class="fs-3 opacity-90">Student ID: {{ student.roll_number }}</p>
                <p class="fs-3 opacity-90">{{ student.classroom.name }} - {{ student.section.name }}</p>
                <p class="fs-4 opacity-80">{{ today|date:"l, F d, Y" }}</p>
            </div>

            <!-- QUICK STATS -->
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-trophy-fill stat-icon grade-{{ overall_grade|lower }}"></i>
                        <h5>Overall Grade</h5>
                        <h2 class="stat-number grade-{{ overall_grade|lower }}">{{ overall_grade }}</h2>
                        <p>Average: {{ overall_average|floatformat:1 }}%</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-calendar-check-fill stat-icon text-success"></i>
                        <h5>Attendance This Month</h5>
                        <h2 class="stat-number text-success">{{ attendance_percentage }}%</h2>
                        <p>{{ present_days }}/{{ total_days }} days</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-chat-dots-fill stat-icon text-info"></i>
                        <h5>Unread Messages</h5>
                        <h2 class="stat-number text-info">{{ unread_messages }}</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-calendar-event-fill stat-icon text-warning"></i>
                        <h5>Next Exam</h5>
                        <h2 class="stat-number text-warning">{{ next_exam.subject.name|default:"No exam" }}</h2>
                        <p>{{ next_exam.date|date:"M d" }}</p>
                    </div>
                </div>
            </div>

            <!-- MY GRADES -->
            <h2 class="fw-bold mb-4">My Grades</h2>
            <div class="row g-4 mb-5">
                {% for sg in subject_grades %}
                <div class="col-md-6 col-lg-4">
                    <div class="card bg-transparent border-0 text-white h-100">
                        <div class="card-body p-4 d-flex flex-column" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);">
                            
                            <h4 class="fw-bold mb-3">{{ sg.subject.name }}</h4>
                            
                            <div class="mt-auto">
                                <p class="mb-2 opacity-90">Latest Score: 
                                    <strong class="{% if sg.latest_score and sg.latest_score >= 80 %}text-success{% elif sg.latest_score and sg.latest_score >= 60 %}text-warning{% elif sg.latest_score %}text-danger{% endif %}">
                                        {{ sg.latest_score|default:"-" }}
                                    </strong>
                                </p>
                                
                                <p class="mb-3 opacity-90">Average: 
                                    <strong>{{ sg.average|floatformat:1 }}%</strong>
                                </p>
                                
                                <!-- Progress Bar -->
                                <div class="progress mb-3" style="height: 12px; border-radius: 10px; background: rgba(0,0,0,0.3);">
                                    <div class="progress-bar 
                                        {% if sg.letter_grade == 'A' or sg.letter_grade == 'A-' %}bg-success
                                        {% elif sg.letter_grade == 'B+' or sg.letter_grade == 'B' or sg.letter_grade == 'B-' %}bg-info
                                        {% elif sg.letter_grade == 'C+' or sg.letter_grade == 'C' or sg.letter_grade == 'C-' %}bg-warning
                                        {% elif sg.letter_grade == 'D' %}bg-orange
                                        {% else %}bg-danger{% endif %}"
                                        role="progressbar"
                                        style="width: {{ sg.average }}%; border-radius: 10px;"
                                        aria-valuenow="{{ sg.average }}"
                                        aria-valuemin="0"
                                        aria-valuemax="100">
                                    </div>
                                </div>
                                
                                <!-- Letter Grade Badge -->
                                <div class="text-end">
                                    <span class="fw-bold fs-3 grade-{{ sg.letter_grade|default:'F'|lower }}">
                                        {{ sg.letter_grade|default:"N/A" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="p-5" style="background: rgba(255,255,255,0.05); border-radius: 24px;">
                        <i class="bi bi-book fs-1 text-muted mb-3"></i>
                        <p class="text-muted fs-4">No scores recorded yet</p>
                        <small class="text-white-50">Your grades will appear here once teachers start entering scores.</small>
                    </div>
                </div>
                {% endfor %}
            </div>

         <!-- ATTENDANCE CALENDAR -->
            <h2 class="fw-bold mb-4">Attendance This Month</h2>
            <div class="card bg-transparent border-0 mb-5">
                <div class="card-body p-4" style="background: rgba(255,255,255,0.1); border-radius: 24px;">
                    
                    <!-- Calendar Grid -->
                    <div class="row text-center g-2">
                        {% for day in attendance_calendar %}
                            <div class="col">
                                <div class="p-3 rounded-3 shadow-sm {% if day.present %}bg-success text-white{% elif day.absent %}bg-danger text-white{% else %}bg-secondary text-white-50{% endif %}">
                                    <div class="fw-bold fs-5">{{ day.date|date:"d" }}</div>
                                    <small class="text-white-75">{{ day.date|date:"D" }}</small>
                                </div>
                            </div>
                            
                            {# Add line break after every 7 days for better layout #}
                            {% if forloop.counter|divisibleby:7 and not forloop.last %}
                                </div><div class="row text-center g-2 mt-2">
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Summary Badges -->
                    <div class="mt-4 text-center">
                        <span class="badge bg-success fs-5 px-4 py-3 me-4 shadow">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Present: {{ present_days }}
                        </span>
                        <span class="badge bg-danger fs-5 px-4 py-3 shadow">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            Absent: {{ absent_days }}
                        </span>
                        <span class="badge bg-info fs-6 px-4 py-2 ms-4">
                            {{ attendance_percentage }}% Attendance
                        </span>
                    </div>

                    <!-- Legend -->
                    <div class="text-center mt-3 small text-white-50">
                        <span class="me-4"><i class="bi bi-square-fill text-success"></i> Present</span>
                        <span class="me-4"><i class="bi bi-square-fill text-danger"></i> Absent</span>
                        <span><i class="bi bi-square-fill text-secondary"></i> No Record / Holiday</span>
                    </div>
                </div>
            </div>

            <!-- MY TIMETABLE -->
            <h2 class="fw-bold mb-4">My Timetable</h2>
            <div class="timetable mb-5">
                <div class="card bg-transparent border-0 shadow-lg" style="background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: 24px; overflow: hidden;">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0">
                                <thead style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                                    <tr>
                                        <th class="text-white fw-bold py-3">Time</th>
                                        <th class="text-white fw-bold py-3">Monday</th>
                                        <th class="text-white fw-bold py-3">Tuesday</th>
                                        <th class="text-white fw-bold py-3">Wednesday</th>
                                        <th class="text-white fw-bold py-3">Thursday</th>
                                        <th class="text-white fw-bold py-3">Friday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in timetable %}
                                    <tr class="{% if entry.is_today_day == 'Monday' and forloop.parentloop.counter == 1 %}table-primary opacity-75{% endif %}">
                                        <td class="fw-bold align-middle py-4" style="background: rgba(255,255,255,0.05);">
                                            {{ entry.period.start_time|time:"h:i A" }} - {{ entry.period.end_time|time:"h:i A" }}
                                            <br>
                                            <small class="text-white-50">Period {{ entry.period.number }}</small>
                                        </td>

                                        <!-- Monday -->
                                        <td class="align-middle py-4 {% if entry.is_today_day == 'Monday' %}today-class{% endif %}">
                                            {% with schedule=entry.schedule.Monday %}
                                                {% if schedule %}
                                                    <div class="fw-bold">{{ schedule.subject.name }}</div>
                                                    <small class="text-white-50">{{ schedule.teacher.get_full_name|default:schedule.teacher.username }}</small>
                                                {% else %}
                                                    <span class="text-white-50">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                        <!-- Tuesday -->
                                        <td class="align-middle py-4 {% if entry.is_today_day == 'Tuesday' %}today-class{% endif %}">
                                            {% with schedule=entry.schedule.Tuesday %}
                                                {% if schedule %}
                                                    <div class="fw-bold">{{ schedule.subject.name }}</div>
                                                    <small class="text-white-50">{{ schedule.teacher.get_full_name|default:schedule.teacher.username }}</small>
                                                {% else %}
                                                    <span class="text-white-50">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                        <!-- Wednesday -->
                                        <td class="align-middle py-4 {% if entry.is_today_day == 'Wednesday' %}today-class{% endif %}">
                                            {% with schedule=entry.schedule.Wednesday %}
                                                {% if schedule %}
                                                    <div class="fw-bold">{{ schedule.subject.name }}</div>
                                                    <small class="text-white-50">{{ schedule.teacher.get_full_name|default:schedule.teacher.username }}</small>
                                                {% else %}
                                                    <span class="text-white-50">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                        <!-- Thursday -->
                                        <td class="align-middle py-4 {% if entry.is_today_day == 'Thursday' %}today-class{% endif %}">
                                            {% with schedule=entry.schedule.Thursday %}
                                                {% if schedule %}
                                                    <div class="fw-bold">{{ schedule.subject.name }}</div>
                                                    <small class="text-white-50">{{ schedule.teacher.get_full_name|default:schedule.teacher.username }}</small>
                                                {% else %}
                                                    <span class="text-white-50">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                        <!-- Friday -->
                                        <td class="align-middle py-4 {% if entry.is_today_day == 'Friday' %}today-class{% endif %}">
                                            {% with schedule=entry.schedule.Friday %}
                                                {% if schedule %}
                                                    <div class="fw-bold">{{ schedule.subject.name }}</div>
                                                    <small class="text-white-50">{{ schedule.teacher.get_full_name|default:schedule.teacher.username }}</small>
                                                {% else %}
                                                    <span class="text-white-50">‚Äî</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="py-5 text-muted">
                                            <i class="bi bi-calendar-x fs-1 mb-3 d-block"></i>
                                            No timetable assigned yet.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Today's Highlight Legend -->
                <div class="text-center mt-3">
                    <small class="text-white-50">
                        <i class="bi bi-circle-fill text-primary me-2"></i>
                        Today is <strong>{{ today|date:"l" }}</strong> ‚Äî your classes are highlighted
                    </small>
                </div>
            </div>

            <!-- PERFORMANCE CHART -->
            <h2 class="fw-bold mb-4">Performance Progress</h2>
            <div class="card bg-transparent border-0 mb-5 shadow-lg" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 24px;">
                <div class="card-body p-4 position-relative">
                    <canvas id="performanceChart" height="120"></canvas>

                    {% if not chart_has_data %}
                    <div class="position-absolute top-50 start-50 translate-middle text-center w-100">
                        <i class="bi bi-bar-chart-line fs-1 text-muted mb-3 d-block"></i>
                        <p class="text-muted fs-5 mb-2">No exam scores recorded yet</p>
                        <small class="text-white-50">
                            Your performance progress will appear here once exams are completed.
                        </small>
                    </div>
                    {% else %}
                    <div class="text-center mt-4">
                        <small class="text-white-50">
                            Your scores vs Class Average ‚Ä¢ Based on recent exams
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <h2 class="fw-bold mb-4">Quick Actions</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <a href="{% url 'report_card' student.id %}" class="btn btn-danger btn-lg w-100 py-4 shadow-lg">
                        <i class="bi bi-file-earmark-text-fill fs-1 mb-3"></i>
                        <h4>View Report Card</h4>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="{% url 'id_card' student.id %}" class="btn btn-warning btn-lg w-100 py-4 shadow-lg">
                        <i class="bi bi-card-heading fs-1 mb-3"></i>
                        <h4>Download ID Card</h4>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="{//}" class="btn btn-primary btn-lg w-100 py-4 shadow-lg">
                        <i class="bi bi-chat-dots-fill fs-1 mb-3"></i>
                        <h4>Message Teacher</h4>
                    </a>
                </div>
            </div>

            <!-- MOTIVATIONAL QUOTE + RANK -->
                <div class="text-center mt-5 py-5">
                    <div class="card bg-transparent border-0 mx-auto" style="max-width: 800px; background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: 32px; padding: 3rem; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        
                        <!-- Motivational Quote -->
                        <figure class="text-center">
                            <blockquote class="blockquote">
                                <p class="quote fs-2 fw-medium lh-lg text-white opacity-90">
                                    "{{ motivational_quote.quote }}"
                                </p>
                            </blockquote>
                            <figcaption class="blockquote-footer text-white-50 mt-3 fs-5">
                                ‚Äî {{ motivational_quote.author|default:"Unknown" }}
                            </figcaption>
                        </figure>

                        <hr class="border-secondary opacity-25 my-5">

                        <!-- Student Rank -->
                        <div class="mt-4">
                            <p class="text-white-50 mb-3">Your Current Standing</p>
                            <div class="d-inline-block rank-badge bg-gradient text-white px-5 py-4 rounded-4 shadow-lg" 
                                style="background: linear-gradient(135deg, #f59e0b, #f97316); font-size: 3rem; font-weight: 800;">
                                #{{ student_rank }}
                            </div>
                            <p class="fs-4 text-warning mt-3 fw-bold">
                                {% if student_rank == 1 %}
                                    üèÜ Class Topper! Keep shining!
                                {% elif student_rank <= 3 %}
                                    üåü Top 3! Amazing performance!
                                {% elif student_rank <= 10 %}
                                    üî• Top 10! You're doing great!
                                {% else %}
                                    üí™ Keep pushing ‚Äî you're improving every day!
                                {% endif %}
                            </p>
                            <small class="text-white-50 d-block mt-3">
                                Based on overall average score in {{ student.classroom.name }}
                            </small>
                        </div>
                    </div>
                </div>
        </div>
    </div>
<script src="{% static 'js/dashboard-chart.js' %}"></script>

</body>
</html>
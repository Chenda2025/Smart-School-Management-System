{% extends "base.html" %}
{% load static %}
{% block title %}AI Assistant ‚Ä¢ Elite International School{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/staff_dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/student_dashboard.css' %}">

<style>
* { font-family: 'Noto Sans Khmer', 'Segoe UI', sans-serif; }

/* Layout */
.chat-wrapper { height: calc(100vh - 120px); display: flex; border-radius: 18px; overflow: hidden; background: #fff; box-shadow: 0 20px 45px rgba(0,0,0,0.08); }

/* Sidebar */
.chat-sidebar { width: 320px; background: #f8f9fb; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
.sidebar-header { padding: 20px; font-weight: 700; color: #2563eb; display: flex; justify-content: space-between; align-items: center; }
.history-list { flex: 1; overflow-y: auto; }
.group-label { padding: 10px 18px; font-size: 12px; color: #6b7280; font-weight: 600; }
.history-item { padding: 14px 18px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
.history-item:hover { background: #eef2ff; }
.history-item.active { background: #2563eb; color: #fff; border-left-color: #1e40af; }
.history-title { font-weight: 600; font-size: 14px; }
.history-preview { font-size: 12px; opacity: 0.8; }

/* Chat Main */
.chat-main { flex: 1; display: flex; flex-direction: column; background: #f3f4f6; }
.chat-header { padding: 20px; background: linear-gradient(135deg, #2563eb, #1e40af); color: #fff; }
.chat-header h4 { margin: 0; font-weight: 600; }
.chat-messages { flex: 1; padding: 25px; overflow-y: auto; }

/* Messages */
.message-row { display: flex; margin-bottom: 18px; }
.message-row.user { justify-content: flex-end; }
.message { max-width: 72%; padding: 14px 20px; border-radius: 18px; line-height: 1.7; animation: fadeIn 0.2s ease; }
.bot { background: #ffffff; border-bottom-left-radius: 6px; }
.user-msg { background: #2563eb; color: #fff; border-bottom-right-radius: 6px; }
.time { font-size: 11px; opacity: 0.6; margin-top: 6px; text-align: right; }

/* Input */
.chat-input { padding: 18px; background: #ffffff; border-top: 1px solid #e5e7eb; }
.chat-input form { display: flex; gap: 10px; }
.chat-input input { flex: 1; border-radius: 999px; padding: 14px 20px; border: none; background: #f3f4f6; }
.chat-input button { border-radius: 999px; padding: 0 26px; background: #2563eb; border: none; color: #fff; font-weight: 600; }
.chat-input button:hover { background: #1e40af; }

/* Animation */
@keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

/* Scrollbar */
.chat-messages::-webkit-scrollbar, .history-list::-webkit-scrollbar { width: 8px; }
.chat-messages::-webkit-scrollbar-thumb, .history-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
<div class="chat-wrapper">

<!-- Sidebar -->
<div class="chat-sidebar">
<div class="sidebar-header">
Chat History
<a href="{% url 'ai_new_chat' %}" class="btn btn-sm btn-primary rounded-pill">
<i class="bi bi-plus"></i>
</a>
</div>

<div class="history-list">
{% if grouped_conversations %}
    {% for label, convos in grouped_conversations.items %}
        {% if convos %}
        <div class="group-label">{{ label }}</div>
            {% for convo in convos %}
            <div class="history-item {% if convo == current_conversation %}active{% endif %}">
                <a href="{% url 'ai_chat_page' convo.id %}" class="flex-grow-1 text-decoration-none">
                    <div class="history-title">{{ convo.title|default:"New Conversation" }}</div>
                    <div class="history-preview">
                        {% if convo.messages.last %}
                            {{ convo.messages.last.content|truncatechars:55 }}
                        {% else %}
                            Start chatting...
                        {% endif %}
                    </div>
                </a>
                <a href="{% url 'ai_delete_chat' convo.id %}" class="btn btn-sm btn-outline-danger ms-2"
                   onclick="return confirm('Are you sure you want to delete this chat?');">
                    <i class="bi bi-trash"></i>
                </a>
            </div>
            {% endfor %}
        {% endif %}
    {% endfor %}
{% else %}
<div class="text-center text-muted mt-5 px-3">
<i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
<p class="mt-3">No chats yet</p>
</div>
{% endif %}
</div>
</div>

<!-- Chat Main -->
<div class="chat-main">
<div class="chat-header">
<h4><i class="bi bi-robot me-2"></i>
{% if current_conversation %} {{ current_conversation.title }} {% else %} AI Assistant {% endif %}
</h4>
<small>English & ·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö ‚Ä¢ Smart School AI</small>
</div>

<div class="chat-messages" id="chat-messages">
{% if messages %}
    {% for msg in messages %}
    <div class="message-row {% if not msg.is_bot %}user{% endif %}">
        <div class="message {% if msg.is_bot %}bot{% else %}user-msg{% endif %}">
            {{ msg.content|linebreaks }}
            <div class="time">{{ msg.timestamp|date:"g:i A" }}</div>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="text-center text-muted mt-5">
<i class="bi bi-robot" style="font-size: 5rem; opacity: 0.2;"></i>
<h5 class="mt-4">·ûü·ûΩ·ûü·üí·ûè·û∏ üëã</h5>
<p>Ask anything about school, homework, exams, events.</p>
</div>
{% endif %}
</div>

<div class="chat-input">
<form id="chat-form">
    {% csrf_token %}
    <input type="text" name="message" id="message-input" placeholder="Type your message..." autocomplete="off" required>
    <button type="submit"><i class="bi bi-send-fill"></i></button>
</form>
<small class="text-muted text-center d-block mt-2">Press Enter to send</small>
</div>
</div>

</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const chat = document.getElementById("chat-messages");
    if(chat) chat.scrollTop = chat.scrollHeight;

    const form = document.getElementById("chat-form");
    const input = document.getElementById("message-input");

    form.addEventListener("submit", async function(e){
        e.preventDefault();
        const msg = input.value.trim();
        if(!msg) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const chatUrl = "{% if current_conversation %}{% url 'ai_chat_page' current_conversation.id %}{% else %}{% url 'ai_new_chat' %}{% endif %}";

        // Add user message immediately
        const msgRow = document.createElement("div");
        msgRow.className = "message-row user";
        msgRow.innerHTML = `<div class="message user-msg">${msg}<div class="time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>`;
        chat.appendChild(msgRow);
        chat.scrollTop = chat.scrollHeight;

        input.value = "";

        // Send message to server
        try {
            const response = await fetch(chatUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken
                },
                body: new URLSearchParams({message: msg})
            });

            if(response.ok){
                location.reload(); // refresh chat to get AI reply
            } else {
                alert("Failed to send message.");
            }
        } catch(err){
            console.error(err);
            alert("Error sending message.");
        }
    });
});
</script>

{% endblock %}

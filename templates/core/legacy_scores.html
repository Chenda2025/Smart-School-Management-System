<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legacy Scores • Elite International School</title>
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); font-family: 'Inter', sans-serif; color: #1e293b; }
        .top-navbar { background: #0f172a; height: 75px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-radius: 28px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-8px); }
        .chart-card { height: 500px; padding: 2rem; }
        .table thead { background: linear-gradient(90deg, #1e40af, #3b82f6); color: white; }
        .badge-grade { font-size: 1rem; padding: 0.5rem 1rem; border-radius: 50px; }
    </style>
</head>
<body>

    <nav class="top-navbar d-flex align-items-center justify-content-between px-4">
        <div class="d-flex align-items-center gap-4">
            <i class="bi bi-clock-history fs-1 text-warning"></i>
            <div>
                <h4 class="mb-0 text-white fw-bold">Legacy Score Archive</h4>
                <small class="text-white-50">Historical Performance Records</small>
            </div>
        </div>
        <div class="d-flex gap-3">
            <a href="{% url 'performance_dashboard' %}" class="btn btn-outline-light rounded-pill">Current Dashboard</a>
            <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light rounded-pill">Staff Home</a>
        </div>
    </nav>

    <div class="container-fluid py-5 px-4">
        <h1 class="text-center display-5 fw-bold mb-5 text-primary">
            <i class="bi bi-archive-fill me-3"></i>Legacy Scores View
        </h1>

        <!-- Filters -->
        <div class="card p-4 mb-5">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="fw-bold">Class</label>
                    <select name="class" class="form-select form-select-lg">
                        <option value="">All Classes</option>
                        {% for c in classrooms %}
                            <option value="{{ c.id }}" {% if selected_class_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold">Exam Type</label>
                    <select name="exam_type" class="form-select form-select-lg">
                        <option value="">All Types</option>
                        {% for value, label in exam_types %}
                            <option value="{{ value }}" {% if selected_exam_type|lower == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold">Year</label>
                    <select name="year" class="form-select form-select-lg">
                        <option value="">All Years</option>
                        {% for y in available_years %}
                            <option value="{{ y }}" {% if selected_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill">
                        <i class="bi bi-funnel me-2"></i>Apply Filters
                    </button>
                </div>
            </form>
        </div>

        <!-- Stats & Charts -->
        <div class="row g-4 mb-5">
            <div class="col-lg-4">
                <div class="card p-4 text-center">
                    <h2 class="display-4 fw-bold text-primary">{{ total_scores }}</h2>
                    <p class="fs-5 text-muted">Total Historical Scores</p>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card p-4 text-center">
                    <h2 class="display-4 fw-bold text-success">{{ avg_score }}%</h2>
                    <p class="fs-5 text-muted">Overall Historical Average</p>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-card card">
                    <h4 class="text-center fw-bold mb-4">Grade Distribution</h4>
                    <div id="gradePie"></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="chart-card card">
                    <h4 class="text-center fw-bold mb-4 text-indigo">Top Subjects (Historical Avg)</h4>
                    <div id="subjectBar"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card card">
                    <h4 class="text-center fw-bold mb-4 text-success">All-Time Top 10 Legends</h4>
                    <div id="topLegends"></div>
                </div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="card p-5">
            <h3 class="text-center fw-bold mb-4">Detailed Score Records</h3>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Roll No</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Exam</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detailed_scores %}
                            <tr>
                                <td><strong>{{ row.full_name }}</strong></td>
                                <td>{{ row.student__roll_number }}</td>
                                <td>{{ row.student__classroom__name }}</td>
                                <td>{{ row.subject__name }}</td>
                                <td><span class="badge bg-primary">{{ row.exam_type|capfirst }}</span></td>
                                <td class="fw-bold">{{ row.score_display }}</td>
                                <td><span class="badge-grade bg-success">{{ row.grade|default:"—" }}</span></td>
                                <td><small>{{ row.recorded_date }}</small></td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="8" class="text-center py-5 text-muted fs-4">No legacy scores found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const config = { responsive: true, displayModeBar: false };

            // Grade Distribution Pie
            Plotly.newPlot('gradePie', [{
                values: {{ grade_values|safe }},
                labels: {{ grade_labels|safe }},
                type: 'pie',
                marker: { colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#94a3b8'] }
            }], { paper_bgcolor: 'transparent' }, config);

            // Subject Bar
            const subjects = {{ subject_perf|safe }};
            Plotly.newPlot('subjectBar', [{
                x: subjects.map(s => s.avg),
                y: subjects.map(s => s.name),
                type: 'bar',
                orientation: 'h',
                marker: { color: '#6366f1' }
            }], { paper_bgcolor: 'transparent', yaxis: { autorange: 'reversed' } }, config);

            // Top Legends
            const legends = {{ historical_top|safe }};
            Plotly.newPlot('topLegends', [{
                x: legends.map(l => l.overall_avg),
                y: legends.map(l => `${l.user__first_name} ${l.user__last_name} (${l.classroom__name})`),
                text: legends.map(l => l.overall_avg + '%'),
                type: 'bar',
                orientation: 'h',
                marker: { color: '#fbbf24' }
            }], { paper_bgcolor: 'transparent', yaxis: { autorange: 'reversed' } }, config);
        });
    </script>
</body>
</html>
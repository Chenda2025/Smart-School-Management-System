<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Users • Elite International School</title>
    {% load static %}

    <!-- Bootstrap + Icons + Font -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Your CSS -->
    <link rel="stylesheet" href="{% static 'css/staff_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/all_users.css' %}">
</head>
<body>

    {% include 'includes/sidebar.html' %}

    <div class="main-content">
        <div class="container-fluid py-5 px-4 px-lg-5">

            <!-- Epic Header -->
            <div class="page-header mb-5">
                <h1 class="display-4 fw-bold mb-3">ALL USERS</h1>
                <p class="lead fs-3 opacity-90">Total Members: <strong class="text-warning">{{ users.count }}</strong></p>
            </div>

            <!-- Stats Row -->
            <div class="row g-4 mb-5">
                <div class="col-md-3"><div class="stats-glass"><h2 class="fw-bold text-danger">{{ admin_count|default:"0" }}</h2><p>Admins</p></div></div>
                <div class="col-md-3"><div class="stats-glass"><h2 class="fw-bold text-purple">{{ teacher_count|default:"0" }}</h2><p>Teachers</p></div></div>
                <div class="col-md-3"><div class="stats-glass"><h2 class="fw-bold text-info">{{ student_count|default:"0" }}</h2><p>Students</p></div></div>
                <div class="col-md-3"><div class="stats-glass"><h2 class="fw-bold text-success">{{ parent_count|default:"0" }}</h2><p>Parents</p></div></div>
            </div>

            <!-- Search Bar - NOW 100% FIXED (NO REDIRECT) -->
            <div class="card glass-card mb-5">
                <div class="card-body p-5">
                    <form method="GET" action="{% url 'all_users_list' %}" class="row g-4 align-items-end">
                        <div class="col-lg-6">
                            <div class="position-relative">
                                <input type="text" 
                                       name="q" 
                                       value="{{ query }}" 
                                       class="form-control form-control-lg search-input rounded-pill" 
                                       placeholder="Search by name, email, username...">
                                <i class="bi bi-search position-absolute top-50 start-4 translate-middle-y fs-5"></i>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <select name="role" class="form-select form-select-lg rounded-pill bg-transparent text-white border-white">
                                <option value="">All Roles</option>
                                <option value="admin" {% if selected_role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="teacher" {% if selected_role == 'teacher' %}selected{% endif %}>Teacher</option>
                                <option value="student" {% if selected_role == 'student' %}selected{% endif %}>Student</option>
                                <option value="parent" {% if selected_role == 'parent' %}selected{% endif %}>Parent</option>
                            </select>
                        </div>

                        <div class="col-lg-2">
                            <button type="submit" class="btn btn-lg btn-light w-100 rounded-pill fw-bold shadow">
                                Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Grid -->
            <div class="row g-4">
                {% for user in users %}
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card user-card text-center text-white">
                        <div class="card-body p-4">
                            {% if user.photo %}
                                <img src="{{ user.photo.url }}" class="rounded-circle user-photo-glow mb-4" alt="{{ user.get_full_name }}">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ user.get_full_name|urlencode }}&background=6366f1&color=fff&size=150&rounded=true&bold=true&font-size=0.4"
                                     class="rounded-circle user-photo-glow mb-4" alt="{{ user.get_full_name }}">
                            {% endif %}

                            <h4 class="fw-bold mb-1">{{ user.get_full_name|default:"Unnamed" }}</h4>
                            <p class="text-white-50 mb-3">@{{ user.username }}</p>

                            <div class="role-glow 
                                {% if user.role == 'admin' %}bg-danger
                                {% elif user.role == 'teacher' %}bg-gradient-purple
                                {% elif user.role == 'student' %}bg-info
                                {% else %}bg-success{% endif %}">
                                {{ user.get_role_display }}
                            </div>

                            <p class="mt-3 mb-2 text-white-50 small">
                                {% if user.role == 'student' and user.student %}
                                    {{ user.student.classroom }} • {{ user.student.section }}
                                {% elif user.role == 'teacher' and user.teacher %}
                                    {{ user.teacher.subjects.all|join:", " }}
                                {% else %}—{% endif %}
                            </p>

                            {% if user.is_active %}
                                <span class="badge bg-success fs-6 px-3 py-2">ACTIVE</span>
                            {% else %}
                                <span class="badge bg-secondary fs-6 px-3 py-2">INACTIVE</span>
                            {% endif %}

                            <div class="mt-4">
                                <a href="{% url 'user_profile' user.id %}" class="btn btn-outline-light btn-sm me-2">View</a>
                                <a href="/admin/users/customuser/{{ user.id }}/change/" class="btn btn-outline-warning btn-sm">Edit</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <h2 class="text-white-50">No users match your search</h2>
                </div>
                {% endfor %}
            </div>

          <!-- NEW — GOES TO YOUR GOD-TIER CUSTOM ADD PAGE -->
            <a href="{% url 'add_user' %}" 
            class="floating-btn position-fixed bottom-0 end-0 m-4 d-flex align-items-center justify-content-center text-white shadow-lg">
                <i class="bi bi-plus-lg fs-1"></i>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/staff_dashboard.js' %}"></script>
</body>
</html>
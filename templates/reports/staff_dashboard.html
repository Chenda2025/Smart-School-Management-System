<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Staff Dashboard • Elite International School</title>
    {% load static %}
    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/staff_dashboard.css' %}">
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --dark: #0f172a;
            --glass: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.2);
            --card-radius: 1.5rem;
        }
        body {
            background: linear-gradient(135deg, var(--dark), #1e293b);
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100vh;
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem 1rem;
            transition: margin-left 0.3s;
        }
        @media (max-width: 992px) {
            .main-content { margin-left: 0; }
        }
        .page-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--card-radius);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(30,64,175,0.4);
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }
        .page-header::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.15), transparent 70%);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .page-header h1 {
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 2rem;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .stat-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 30px 60px rgba(30,64,175,0.5);
        }
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
        }
        .rank-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.2rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.05);
        }
        .rank-item:hover {
            background: rgba(59,130,246,0.2);
            transform: translateX(10px);
        }
        .rank-position {
            font-size: 2.2rem;
            font-weight: 700;
            width: 70px;
            text-align: center;
        }
        .rank-1 { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-light);
            box-shadow: 0 0 15px rgba(59,130,246,0.4);
        }
        .quick-actions .btn {
            border-radius: 2rem;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 1rem 2.5rem;
            transition: all 0.4s ease;
        }
        .quick-actions .btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    {% include 'includes/sidebar.html' %}

    <div class="main-content">
    <div class="container-fluid py-5">
        <!-- Header -->
        <div class="page-header">
            <h1>WELCOME BACK, {{ user.get_full_name|upper|default:"SUPER STAFF" }}</h1>
            <p>Elite International School • {{ today|date:"l, F d, Y" }}</p>
        </div>

        <!-- Stats Grid -->
        <div class="row g-4 mb-5">
            <div class="col-md-6 col-lg-3">
                <div class="stat-card">
                    <i class="bi bi-people-fill stat-icon text-info"></i>
                    <h5>Total Students</h5>
                    <h2 class="stat-number text-info">{{ total_students }}</h2>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card">
                    <i class="bi bi-check-circle-fill stat-icon text-success"></i>
                    <h5>Attendance Today</h5>
                    <h2 class="stat-number text-success">{{ attendance_percent }}%</h2>
                    <small class="text-muted">{{ present_today }} present</small>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card">
                    <i class="bi bi-mortarboard-fill stat-icon text-warning"></i>
                    <h5>Total Teachers</h5>
                    <h2 class="stat-number text-warning">{{ total_teachers|default:"--" }}</h2>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stat-card">
                    <i class="bi bi-trophy-fill stat-icon text-danger"></i>
                    <h5>Top Performers</h5>
                    <h2 class="stat-number text-danger">{{ top_students|length }}</h2>
                    <small class="text-muted">Scored above average</small>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Top 5 Performing Students -->
            <div class="col-lg-6">
                <div class="card" style="background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--card-radius);">
                    <div class="card-body p-4">
                        <h4 class="mb-4"><i class="bi bi-trophy-fill me-2 text-warning"></i>Top 5 Performing Students</h4>

                        {% if top_students %}
                            {% for student in top_students %}
                                {% with forloop.counter as position %}
                                <div class="rank-item">
                                    <div class="rank-position rank-{{ position }}">{{ position }}</div>

                                    <!-- SAFE PHOTO + INITIALS -->
                                    <div class="photo-wrapper position-relative d-inline-block">
                                        {% if student.photo %}
                                            <img src="{{ student.photo.url }}" class="avatar" alt="{{ student.user.get_full_name|default:student.roll_number }}">
                                        {% else %}
                                            <div class="initials-avatar">
                                                {{ student.user.first_name|slice:":1"|upper }}{{ student.user.last_name|slice:":1"|upper }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ student.user.get_full_name|default:student.roll_number }}</h6>
                                        <small class="text-muted">
                                            {{ student.classroom.name }}
                                            {% if student.section %} - {{ student.section.name }}{% endif %}
                                        </small>
                                    </div>

                                    <div class="text-end">
                                        <strong class="display-6">{{ student.avg_score|floatformat:1 }}%</strong>
                                        <div class="progress mt-2" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: {{ student.avg_score }}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-muted py-5">No score data available yet</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Students Needing Attention -->
            <div class="col-lg-6">
                <div class="card" style="background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--card-radius);">
                    <div class="card-body p-4">
                        <h4 class="mb-4"><i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>Students Needing Attention</h4>

                        {% if weak_students %}
                            {% for student in weak_students %}
                                {% with avg_score=student.avg_score|floatformat:0 %}
                                <div class="rank-item border-start
                                    {% if avg_score < 40 %}border-danger
                                    {% elif avg_score < 60 %}border-warning
                                    {% else %}border-info{% endif %} border-5 ps-3">

                                    <!-- FIXED: SAFE PHOTO + INITIALS FALLBACK -->
                                    <div class="photo-wrapper position-relative d-inline-block">
                                        {% if student.photo %}
                                            <img src="{{ student.photo.url }}" class="avatar" alt="{{ student.user.get_full_name|default:student.roll_number }}">
                                        {% else %}
                                            <div class="initials-avatar">
                                                {{ student.user.first_name|slice:":1"|upper }}{{ student.user.last_name|slice:":1"|upper }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ student.user.get_full_name|default:student.roll_number }}</h6>
                                        <small class="text-muted">
                                            {{ student.classroom.name }}
                                            {% if student.section %} - {{ student.section.name }}{% endif %}
                                        </small>
                                    </div>

                                    <div class="text-end">
                                        <strong class="fs-4">{{ student.avg_score|floatformat:1 }}%</strong><br>
                                        {% if avg_score < 40 %}
                                            <span class="badge bg-danger mt-1">Critical</span>
                                        {% elif avg_score < 60 %}
                                            <span class="badge bg-warning mt-1">At Risk</span>
                                        {% else %}
                                            <span class="badge bg-info mt-1">Monitor</span>
                                        {% endif %}
                                        <div class="progress mt-2" style="height: 8px;">
                                            <div class="progress-bar {% if avg_score < 60 %}bg-warning{% else %}bg-info{% endif %}"
                                                 style="width: {{ student.avg_score }}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-success py-5"><i class="bi bi-check-circle fs-1"></i><br>All students are performing well!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="text-center mt-5 quick-actions">
            <a href="{% url 'report_list' %}" class="btn btn-warning btn-lg shadow-lg me-4">
                <i class="bi bi-card-heading me-2"></i> Generate ID Cards
            </a>
            <a href="{% url 'qr_scan' %}" class="btn btn-primary btn-lg shadow-lg">
                <i class="bi bi-qr-code-scan me-2"></i> Scan QR Card
            </a>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
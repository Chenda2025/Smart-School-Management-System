<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Dashboard • Elite International School</title>
    {% load static %}
    {% load filters %}
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            margin: 0; padding: 0; min-height: 100vh; color: #1e293b;
        }
        .top-navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 75px;
            background: var(--dark);
            color: white;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 0 2rem;
        }
        .main-content {
            padding-top: 95px;
            padding-left: 2rem;
            padding-right: 2rem;
            padding-bottom: 4rem;
        }
        .card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 28px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
        }
        .card:hover {
            transform: translateY(-12px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.18);
        }
        .big-card {
            padding: 3rem 1.5rem;
            text-align: center;
            background: white;
            border-radius: 28px;
        }
        .big-num {
            font-size: 5.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .chart-card {
            height: 480px;
            padding: 2rem;
            background: white;
            border-radius: 28px;
        }
        .table thead {
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            color: white;
            font-weight: 600;
        }
        .table tbody tr:hover {
            background: #f0f9ff !important;
        }
        /* Rank badges */
        .rank-1 { background: #fbbf24 !important; color: #000 !important; font-weight: bold; }
        .rank-2 { background: #94a3b8 !important; color: white !important; }
        .rank-3 { background: #fb923c !important; color: white !important; }
        /* Score colors */
        .score-90 { background: #dcfce7 !important; color: #166534 !important; font-weight: 700; }
        .score-80 { background: #dbeafe !important; color: #1e40af !important; font-weight: 700; }
        .score-60 { background: #fef3c7 !important; color: #92400e !important; }
        .score-fail { background: #fee2e2 !important; color: #991b1b !important; font-weight: 700; }
        @media (max-width: 992px) {
            .big-num { font-size: 4rem; }
            .chart-card { height: 400px; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 95px 1rem 3rem; }
            .big-num { font-size: 3.2rem; }
            .top-navbar { padding: 0 1rem; height: 80px; }
        }
    </style>
</head>
<body>
    <!-- TOP NAVBAR -->
    <nav class="top-navbar d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-4">
            <i class="bi bi-graph-up-arrow fs-1 text-primary"></i>
            <div>
                <h4 class="mb-0 fw-bold">Performance Dashboard</h4>
                <small class="opacity-80">Live • {{ "now"|date:"F Y" }}</small>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <select class="form-select form-select-lg rounded-pill px-4" onchange="location.href='?grade='+this.value">
                <option value="">All Classes</option>
                {% for c in classrooms %}
                    <option value="{{ c.id }}" {% if selected_grade == c.id|stringformat:"s" %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                {% endfor %}
            </select>
            <span class="small opacity-75 d-none d-lg-block">
                <i class="bi bi-person-fill"></i> {{ request.user.get_full_name|default:request.user.username }}
            </span>
            <a href="{% url 'staff_dashboard' %}" class="btn btn-outline-light rounded-pill px-4">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
            </a>
            <!-- <a href="{% url 'logout' %}" class="btn btn-danger rounded-pill px-4">
                <i class="bi bi-box-arrow-right"></i>
            </a> -->
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="container-fluid">

            <!-- BIG 4 STATS -->
            <div class="row g-4 mb-5">
                <div class="col-md-3 col-6">
                    <div class="big-card">
                        <div class="big-num">{{ total_students }}</div>
                        <small class="text-muted fw-bold fs-5">Total Students</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="big-card">
                        <div class="big-num text-success">{{ avg_score|floatformat:1 }}%</div>
                        <small class="text-muted fw-bold fs-5">Average Score</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="big-card">
                        <div class="big-num text-info">{{ pass_rate|floatformat:1 }}%</div>
                        <small class="text-muted fw-bold fs-5">Pass Rate (≥60%)</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="big-card">
                        <div class="big-num text-danger">{{ at_risk }}</div>
                        <small class="text-muted fw-bold fs-5">At Risk Students</small>
                    </div>
                </div>
            </div>

            <!-- CHARTS ROW -->
            <div class="row g-4 mb-5">
                <!-- Gender Distribution -->
                <div class="col-lg-6">
                    <div class="chart-card card">
                        <h4 class="text-center fw-bold mb-4 text-primary">
                            <i class="bi bi-people-fill me-2"></i>Gender Distribution
                        </h4>
                        <div id="pieChart"></div>
                    </div>
                </div>

                <!-- Subject Radar -->
                <div class="col-lg-6">
                    <div class="chart-card card">
                        <h4 class="text-center fw-bold mb-4 text-indigo">
                            <i class="bi bi-pie-chart-fill me-2"></i>Subject Performance
                        </h4>
                        <div id="radarChart"></div>
                    </div>
                </div>

                <!-- Top 10 -->
                <div class="col-lg-6">
                    <div class="chart-card card">
                        <h4 class="text-center fw-bold mb-4 text-success">
                            <i class="bi bi-trophy-fill me-2"></i>Top 10 Performers
                        </h4>
                        <div id="top10Chart"></div>
                    </div>
                </div>

                <!-- Bottom 10 -->
                <div class="col-lg-6">
                    <div class="chart-card card">
                        <h4 class="text-center fw-bold mb-4 text-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Needs Support
                        </h4>
                        <div id="bottom10Chart"></div>
                    </div>
                </div>
            </div>

            <!-- STUDENT PERFORMANCE TABLE -->
            <div class="card p-5 shadow-lg">
                <h3 class="text-center fw-bold mb-5 display-6 text-primary">
                    Student Performance • <span class="text-dark">{{ selected_grade_name }}</span>
                </h3>
                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle table-bordered">
                        <thead class="text-white">
                            <tr>
                                <th>Rank</th>
                                <th>Name</th>
                                <th>Roll No</th>
                                <th>Class</th>
                                {% for subject in subjects %}
                                    <th>{{ subject.name }}</th>
                                {% endfor %}
                                <th>Total</th>
                                <th>Avg %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in student_matrix %}
                                <tr>
                                    <td class="fw-bold fs-5 {% if forloop.counter <= 3 %}rank-{{ forloop.counter }}{% endif %}">
                                        {% if forloop.counter == 1 %}1st
                                        {% elif forloop.counter == 2 %}2nd
                                        {% elif forloop.counter == 3 %}3rd
                                        {% else %}{{ forloop.counter }}th{% endif %}
                                    </td>
                                    <td class="text-start fw-bold">{{ row.name }}</td>
                                    <td>{{ row.roll_number }}</td>
                                    <td>{{ row.classroom }}</td>
                                    {% for subject in subjects %}
                                        {% with score=row.scores|get_item:subject.name %}
                                            <td class="{% if score >= 90 %}score-90
                                                       {% elif score >= 80 %}score-80
                                                       {% elif score >= 60 %}score-60
                                                       {% elif score is not None %}score-fail{% endif %}">
                                                <strong>{{ score|floatformat:1|default:"—" }}</strong>
                                            </td>
                                        {% endwith %}
                                    {% endfor %}
                                    <td class="fw-bold fs-4 text-primary">{{ row.total|floatformat:1 }}</td>
                                    <td class="fw-bold fs-4 text-success">{{ row.average|floatformat:1 }}%</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="{{ subjects|length|add:6 }}" class="py-6 text-muted fs-4">
                                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                        No student performance data available
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- PLOTLY SCRIPTS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const config = { responsive: true, displayModeBar: false };

            // Gender Pie Chart
            const genderData = {{ gender_pie|safe }};
            Plotly.newPlot('pieChart', [{
                values: genderData.map(g => g.value),
                labels: genderData.map(g => g.label),
                type: 'pie',
                hole: 0.5,
                textinfo: 'label+percent',
                marker: { colors: ['#3b82f6', '#ef4444', '#10b981'] }
            }], {
                paper_bgcolor: 'transparent',
                font: { color: '#1e293b' }
            }, config);

            // Subject Radar
            const subjects = {{ subject_averages|safe }};
            Plotly.newPlot('radarChart', [{
                type: 'scatterpolar',
                r: subjects.map(s => s.avg),
                theta: subjects.map(s => s.name),
                fill: 'toself',
                fillcolor: 'rgba(99, 102, 241, 0.2)',
                line: { color: '#6366f1' }
            }], {
                polar: { radialaxis: { range: [0, 100], tickfont: { size: 12 } } },
                paper_bgcolor: 'transparent',
                font: { color: '#1e293b' }
            }, config);

            // Top 10
            const top10 = {{ top_10|safe }};
            Plotly.newPlot('top10Chart', [{
                x: top10.map(s => s.avg),
                y: top10.map(s => s.name + ' (' + s.classroom + ')'),
                text: top10.map(s => s.avg.toFixed(1) + '%'),
                textposition: 'outside',
                type: 'bar',
                orientation: 'h',
                marker: { color: '#10b981' }
            }], {
                xaxis: { title: 'Average %', range: [0, 100] },
                yaxis: { autorange: 'reversed' },
                paper_bgcolor: 'transparent',
                font: { color: '#1e293b' }
            }, config);

            // Bottom 10
            const bottom10 = {{ bottom_10|safe }};
            Plotly.newPlot('bottom10Chart', [{
                x: bottom10.map(s => s.avg),
                y: bottom10.map(s => s.name + ' (' + s.classroom + ')'),
                text: bottom10.map(s => s.avg.toFixed(1) + '%'),
                textposition: 'outside',
                type: 'bar',
                orientation: 'h',
                marker: { color: '#ef4444' }
            }], {
                xaxis: { title: 'Average %', range: [0, 100] },
                yaxis: { autorange: 'reversed' },
                paper_bgcolor: 'transparent',
                font: { color: '#1e293b' }
            }, config);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile â€¢ Elite International School</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f1f5f9, #e0e7ff);
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        .main-content {
            margin-left: 300px;
            padding: 3rem;
        }
        @media (max-width: 991px) {
            .main-content { margin-left: 0; }
        }
        .page-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 4rem 2rem;
            text-align: center;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 15px 40px rgba(99,102,241,0.3);
        }
        .page-header h1 {
            font-size: 3.5rem;
            font-weight: 900;
        }
        .profile-card {
            background: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 30px 80px rgba(99,102,241,0.2);
            padding: 4rem;
        }
        .profile-photo {
            width: 220px;
            height: 220px;
            object-fit: cover;
            border-radius: 50%;
            border: 10px solid white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        }
        .info-item {
            background: #f8fafc;
            border-radius: 16px;
            padding: 1.8rem;
            margin-bottom: 1.2rem;
            transition: all 0.3s;
        }
        .info-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-action {
            padding: 1rem 2.5rem;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .btn-action:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .btn-edit {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }
        .btn-print {
            background: #17a2b8;
        }
        .btn-export {
            background: #28a745;
        }

        /* Hide print area on screen */
        .print-area {
            display: none;
            padding: 3rem;
            background: white;
            max-width: 210mm;
            margin: 0 auto;
        }

        /* Perfect print layout */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; display: block !important; }
            .sidebar, .main-content > *:not(.print-area) { display: none !important; }
            .print-area {
                position: absolute;
                left: 0; top: 0;
                width: 100%;
                box-shadow: none;
            }
        }

        .print-header {
            text-align: center;
            margin-bottom: 3rem;
            border-bottom: 4px double #6366f1;
            padding-bottom: 2rem;
        }
        .print-header img {
            height: 100px;
            margin-bottom: 1rem;
        }
        .print-header h2 {
            font-size: 2.8rem;
            color: #1e293b;
            margin: 1rem 0;
        }
        .print-photo {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 50%;
            border: 8px solid #6366f1;
            margin: 2rem auto;
            display: block;
        }
        .print-info {
            font-size: 1.3rem;
            line-height: 2.2;
        }
        .print-info strong {
            color: #6366f1;
        }
    </style>
</head>
<body>
    {% include 'includes/sidebar_teacher.html' %}

    <div class="main-content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10 col-xl-8">
                    <div class="page-header">
                        <h1>My Profile</h1>
                    </div>

                    <div class="profile-card">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <div class="text-center mb-5">
                            <img src="{{ profile_data.photo }}" class="profile-photo" alt="Profile Photo">
                            <h2 class="mt-4 fw-bold fs-1">{{ profile_data.user.get_full_name }}</h2>
                            <p class="text-muted fs-3">{{ profile_data.user.role|capfirst }}</p>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6"><div class="info-item"><strong>Email</strong><p>{{ profile_data.user.email }}</p></div></div>
                            <div class="col-md-6"><div class="info-item"><strong>Phone</strong><p>{{ profile_data.phone }}</p></div></div>
                            <div class="col-md-6"><div class="info-item"><strong>Join Date</strong><p>{{ profile_data.join_date|date:"d F Y" }}</p></div></div>
                        </div>

                        {% if profile_data.user.role == 'teacher' %}
                            <h3 class="mt-5 fw-bold text-primary">Teaching Information</h3>
                            <div class="row g-4">
                                {% for classroom in profile_data.classes %}
                                    <div class="col-md-6"><div class="info-item"><strong>{{ classroom.name }}</strong></div></div>
                                {% endfor %}
                            </div>
                            <p class="mt-3"><strong>Total Students:</strong> {{ profile_data.total_students }}</p>
                        {% endif %}

                        {% if profile_data.user.role == 'student' %}
                            <h3 class="mt-5 fw-bold text-primary">Student Information</h3>
                            <p><strong>Class:</strong> {{ profile_data.classroom.name }}</p>
                            <p><strong>Roll No:</strong> {{ profile_data.student.roll_number }}</p>
                        {% endif %}

                        {% if profile_data.user.role == 'parent' %}
                            <h3 class="mt-5 fw-bold text-primary">My Children</h3>
                            <div class="row g-4">
                                {% for child in profile_data.children %}
                                    <div class="col-md-4"><div class="info-item text-center"><strong>{{ child.user.get_full_name }}</strong><p>{{ child.classroom.name }}</p></div></div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="text-center mt-5">
                            <button class="btn btn-edit btn-action text-white me-3" data-bs-toggle="modal" data-bs-target="#editModal">
                                <i class="bi bi-pencil me-2"></i> Edit Profile
                            </button>
                            <button onclick="window.print()" class="btn btn-print btn-action text-white me-3">
                                <i class="bi bi-printer me-2"></i> Print Profile
                            </button>
                            <button onclick="exportPDF()" class="btn btn-export btn-action text-white">
                                <i class="bi bi-file-earmark-pdf me-2"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <!-- Hidden Print Area - Beautiful Layout for Print & PDF -->
                    <div class="print-area">
                        <div class="print-header">
                            <img src="{% static 'images/school-logo.png' %}" alt="Elite International School" onerror="this.style.display='none'">
                            <h2>My Profile</h2>
                            <p class="print-info"><strong>Name:</strong> {{ profile_data.user.get_full_name }}</p>
                            <p class="print-info"><strong>Role:</strong> {{ profile_data.user.role|capfirst }}</p>
                            <p class="print-info"><strong>Email:</strong> {{ profile_data.user.email }}</p>
                            <p class="print-info"><strong>Phone:</strong> {{ profile_data.phone }}</p>
                            <p class="print-info"><strong>Join Date:</strong> {{ profile_data.join_date|date:"d F Y" }}</p>
                            <p class="print-info"><strong>Printed on:</strong> <span id="printDate"></span></p>
                        </div>

                        <div class="text-center mb-5">
                            <img src="{{ profile_data.photo }}" class="print-photo" alt="Profile Photo">
                        </div>

                        {% if profile_data.user.role == 'teacher' %}
                            <h3 class="text-primary fw-bold">Teaching Information</h3>
                            <p class="print-info"><strong>Assigned Classes:</strong></p>
                            <ul class="print-info">
                                {% for classroom in profile_data.classes %}
                                    <li>{{ classroom.name }}</li>
                                {% endfor %}
                            </ul>
                            <p class="print-info"><strong>Total Students:</strong> {{ profile_data.total_students }}</p>
                        {% endif %}

                        <div class="mt-5 text-center">
                            <p class="print-info"><strong>Signature:</strong> ___________________________</p>
                            <p class="print-info"><strong>Date:</strong> ___________________________</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Profile</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <img src="{{ profile_data.photo }}" class="rounded-circle shadow" width="150" id="photoPreview" alt="Preview">
                            <div class="mt-3">
                                <label class="btn btn-primary">
                                    Change Photo <input type="file" name="photo" style="display:none;" onchange="previewPhoto(this)">
                                </label>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <input type="text" name="first_name" class="form-control" value="{{ profile_data.user.first_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <input type="text" name="last_name" class="form-control" value="{{ profile_data.user.last_name }}" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" value="{{ profile_data.user.email }}" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Phone</label>
                                <input type="text" name="phone" class="form-control" value="{{ profile_data.phone }}">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Set current date in print area
        document.getElementById('printDate').textContent = new Date().toLocaleDateString('en-GB');

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const printArea = document.querySelector('.print-area');

            // Temporarily show for capture
            printArea.style.display = 'block';

            try {
                const canvas = await html2canvas(printArea, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 40;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let position = 10;
                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);

                pdf.save('My_Profile_Elite_International_School.pdf');
            } catch (err) {
                alert('Failed to generate PDF. Please try again.');
                console.error(err);
            } finally {
                printArea.style.display = 'none';
            }
        }

        function previewPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('photoPreview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>